# Search Agent ì„¤ëª…ì„œ

> `src/agent/nodes/search_agent.py` íŒŒì¼ì˜ êµ¬ì¡°ì™€ ë™ì‘ ë°©ì‹ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## ğŸ“‹ ëª©ì°¨

1. [íŒŒì¼ ê°œìš”](#íŒŒì¼-ê°œìš”)
2. [ì£¼ìš” í•¨ìˆ˜](#ì£¼ìš”-í•¨ìˆ˜)
3. [ê²€ìƒ‰ ë¡œì§ íë¦„](#ê²€ìƒ‰-ë¡œì§-íë¦„)
4. [ì½”ë“œ êµ¬ì¡°](#ì½”ë“œ-êµ¬ì¡°)

---

## íŒŒì¼ ê°œìš”

### ì—­í• 

ì‚¬ìš©ì ì§ˆë¬¸ì„ ë°›ì•„ì„œ **Qdrant(Vector DB)ì—ì„œ ê´€ë ¨ ë¬¸ì„œë¥¼ ê²€ìƒ‰**í•˜ê³ , ìµœì¢…ì ìœ¼ë¡œ `top_k`ê°œì˜ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ëŠ” ì‹¤í–‰/í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.

### í•µì‹¬ ì „ëµ

- **ë“€ì–¼ ì¿¼ë¦¬ ê²€ìƒ‰**: í•œê¸€ ì§ˆë¬¸ì¼ ë•Œ "ì›ë¬¸(í•œê¸€) + ë²ˆì—­(ì˜ì–´)" ë‘ ê°€ì§€ ì¿¼ë¦¬ë¡œ ê²€ìƒ‰í•´ recallì„ ë†’ì„
- **ì†ŒìŠ¤ë³„ ê²€ìƒ‰**: ê°•ì˜ ìë£Œ(lecture)ì™€ Python ê³µì‹ë¬¸ì„œ(python_doc_rst)ë¥¼ ê°ê° ê²€ìƒ‰
- **ì–¸ì–´ ìµœì í™”**: 
  - lectureëŠ” í•œêµ­ì–´ í…ìŠ¤íŠ¸ â†’ í•œê¸€ ì§ˆë¬¸ìœ¼ë¡œ ê²€ìƒ‰
  - python_doc_rstëŠ” ì˜ì–´ ë¬¸ì„œ â†’ ì˜ì–´ ë²ˆì—­ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰

---

## ì£¼ìš” í•¨ìˆ˜

### 1. `is_korean(text: str) -> bool`

**ì—­í• **: í…ìŠ¤íŠ¸ì— í•œê¸€ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

**ì‚¬ìš© ìœ„ì¹˜**: ì§ˆë¬¸ ì–¸ì–´ë¥¼ íŒë³„í•´ì„œ ê²€ìƒ‰ ì „ëµì„ ê²°ì •í•  ë•Œ

```python
is_korean("ë¨¸ì‹ ëŸ¬ë‹ì´ ë­ì•¼?")  # True
is_korean("What is machine learning?")  # False
```

---

### 2. `translate_to_english(question: str) -> str`

**ì—­í• **: í•œê¸€ ì§ˆë¬¸ì„ ì˜ì–´ ê²€ìƒ‰ í‚¤ì›Œë“œë¡œ ë³€í™˜

**ì‚¬ìš© ìœ„ì¹˜**: í•œê¸€ ì§ˆë¬¸ì¼ ë•Œ python_doc_rst ê²€ìƒ‰ ì „ì— í˜¸ì¶œ

**í”„ë¡¬í”„íŠ¸**: `src/agent/prompts/translate_prompt.py`ì˜ `TRANSLATE_PROMPT` ì‚¬ìš©

**ì˜ˆì‹œ**:
```python
translate_to_english("ë”•ì…”ë„ˆë¦¬ ì‚¬ìš©ë²•")
# â†’ "dictionary display dict methods dict.get() dict.keys()"
```

---

### 3. `search_by_source(query: str, source: str, executor: SearchExecutor, top_k: int) -> list`

**ì—­í• **: íŠ¹ì • ì†ŒìŠ¤(lecture ë˜ëŠ” python_doc_rst)ì—ì„œë§Œ ê²€ìƒ‰

**íŒŒë¼ë¯¸í„°**:
- `query`: ê²€ìƒ‰ ì¿¼ë¦¬ (ì§ˆë¬¸ ì›ë¬¸ ë˜ëŠ” ë²ˆì—­)
- `source`: `"lecture"` ë˜ëŠ” `"python_doc_rst"`
- `executor`: SearchExecutor ì¸ìŠ¤í„´ìŠ¤ (Qdrant ì—°ê²°)
- `top_k`: ê°€ì ¸ì˜¬ ë¬¸ì„œ ê°œìˆ˜

**ë°˜í™˜ê°’**: ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ (ê° í•­ëª©ì€ `{"content": str, "score": float, "metadata": dict}`)

**í•µì‹¬**: Qdrantì˜ `metadata.source` í•„í„°ë¥¼ ì‚¬ìš©í•´ì„œ ì†ŒìŠ¤ë³„ë¡œ ë¶„ë¦¬ ê²€ìƒ‰

---

### 4. `execute_dual_query_search(question: str, executor: SearchExecutor) -> tuple`

**ì—­í• **: ë©”ì¸ ê²€ìƒ‰ í•¨ìˆ˜ - ì „ì²´ ê²€ìƒ‰ ë¡œì§ì„ ì‹¤í–‰

**ë°˜í™˜ê°’**: `(results: List[Dict], query_info: Dict)`

**query_info êµ¬ì¡°**:
```python
{
    "original": "ì›ë³¸ ì§ˆë¬¸",
    "translated": "ë²ˆì—­ëœ ì˜ì–´ í‚¤ì›Œë“œ" (í•œê¸€ ì§ˆë¬¸ì¼ ë•Œë§Œ),
    "queries_used": ["ì›ë³¸: ...", "ë²ˆì—­(python_doc_rst): ..."]
}
```

---

## ê²€ìƒ‰ ë¡œì§ íë¦„

### ì „ì²´ íë¦„ë„

```
ì‚¬ìš©ì ì§ˆë¬¸
    â†“
[1ë‹¨ê³„] Router í˜¸ì¶œ (build_search_config)
    - sources ê²°ì •: ['lecture'] / ['python_doc'] / ë‘˜ ë‹¤
    - top_k ê²°ì •: 3 (basic) / 5 (intermediate) / 7 (advanced)
    â†“
[2ë‹¨ê³„] ì†ŒìŠ¤ë³„ ê²€ìƒ‰
    â”œâ”€ lecture ê²€ìƒ‰ (ì›ë¬¸ ê·¸ëŒ€ë¡œ)
    â””â”€ python_doc_rst ê²€ìƒ‰
        â”œâ”€ í•œê¸€ ì§ˆë¬¸ì´ë©´: ë²ˆì—­(ì˜ì–´) ê²€ìƒ‰ â†’ fallback(í•œê¸€ ì›ë¬¸)
        â””â”€ ì˜ì–´ ì§ˆë¬¸ì´ë©´: ì›ë¬¸(ì˜ì–´) ê·¸ëŒ€ë¡œ
    â†“
[3ë‹¨ê³„] ê²°ê³¼ í•©ì¹˜ê¸°
    - ì¤‘ë³µ ì œê±° (ì•ë¶€ë¶„ 100ì ê¸°ì¤€)
    - ì ìˆ˜ìˆœ ì •ë ¬
    - top_kê°œë§Œ ë°˜í™˜
```

---

### ìƒì„¸ ë¡œì§ (í•œê¸€ ì§ˆë¬¸ ì˜ˆì‹œ)

**ì§ˆë¬¸**: "ë”•ì…”ë„ˆë¦¬ ì‚¬ìš©ë²•"

#### 1) Router í˜¸ì¶œ
```python
config = build_search_config("ë”•ì…”ë„ˆë¦¬ ì‚¬ìš©ë²•")
# ê²°ê³¼ ì˜ˆì‹œ:
# {
#     'sources': ['python_doc'],
#     'top_k': 3,
#     'search_method': 'similarity'
# }
```

#### 2) ì†ŒìŠ¤ë³„ ê²€ìƒ‰

**lecture ê²€ìƒ‰** (sourcesì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´):
```python
lecture_results = search_by_source("ë”•ì…”ë„ˆë¦¬ ì‚¬ìš©ë²•", "lecture", executor, 3)
# â†’ í•œê¸€ ì›ë¬¸ìœ¼ë¡œ lectureì—ì„œ 3ê°œ ê²€ìƒ‰
```

**python_doc_rst ê²€ìƒ‰**:
```python
# 2-1) ë²ˆì—­(ì˜ì–´ í‚¤ì›Œë“œ) ê²€ìƒ‰
english_query = translate_to_english("ë”•ì…”ë„ˆë¦¬ ì‚¬ìš©ë²•")
# â†’ "dictionary display dict methods dict.get() dict.keys()"

python_results_en = search_by_source(english_query, "python_doc_rst", executor, 3)
# â†’ ì˜ì–´ í‚¤ì›Œë“œë¡œ python_doc_rstì—ì„œ 3ê°œ ê²€ìƒ‰

# 2-2) fallback (ë²ˆì—­ ê²°ê³¼ê°€ ì•½í•˜ë©´)
best_score = python_results_en[0]["score"]  # ì˜ˆ: 0.42
if best_score < 0.45:
    python_results = search_by_source("ë”•ì…”ë„ˆë¦¬ ì‚¬ìš©ë²•", "python_doc_rst", executor, 3)
    # â†’ í•œê¸€ ì›ë¬¸ìœ¼ë¡œë„ 1ë²ˆ ë” ê²€ìƒ‰
```

#### 3) ê²°ê³¼ í•©ì¹˜ê¸°
```python
all_results = lecture_results + python_results_en + python_results
# â†’ ì¤‘ë³µ ì œê±° â†’ ì ìˆ˜ìˆœ ì •ë ¬ â†’ top_k(3)ê°œ ë°˜í™˜
```

---

### ìƒì„¸ ë¡œì§ (ì˜ì–´ ì§ˆë¬¸ ì˜ˆì‹œ)

**ì§ˆë¬¸**: "list comprehension syntax"

#### 1) Router í˜¸ì¶œ
```python
config = build_search_config("list comprehension syntax")
# ê²°ê³¼ ì˜ˆì‹œ:
# {
#     'sources': ['python_doc'],
#     'top_k': 3,
#     'search_method': 'similarity'
# }
```

#### 2) ì†ŒìŠ¤ë³„ ê²€ìƒ‰

**lecture ê²€ìƒ‰** (sourcesì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´):
```python
lecture_results = search_by_source("list comprehension syntax", "lecture", executor, 3)
# â†’ ì˜ì–´ ì›ë¬¸ìœ¼ë¡œ lectureì—ì„œ 3ê°œ ê²€ìƒ‰
```

**python_doc_rst ê²€ìƒ‰**:
```python
python_results = search_by_source("list comprehension syntax", "python_doc_rst", executor, 3)
# â†’ ì˜ì–´ ì›ë¬¸ ê·¸ëŒ€ë¡œ python_doc_rstì—ì„œ 3ê°œ ê²€ìƒ‰
# (ë²ˆì—­ ì—†ìŒ - ì´ë¯¸ ì˜ì–´ë¼ì„œ)
```

#### 3) ê²°ê³¼ í•©ì¹˜ê¸°
```python
all_results = lecture_results + python_results
# â†’ ì¤‘ë³µ ì œê±° â†’ ì ìˆ˜ìˆœ ì •ë ¬ â†’ top_k(3)ê°œ ë°˜í™˜
```

---

## ì½”ë“œ êµ¬ì¡°

### í•¨ìˆ˜ë³„ ì—­í• 

| í•¨ìˆ˜ëª… | ì—­í•  | í˜¸ì¶œ ìœ„ì¹˜ |
|--------|------|-----------|
| `is_korean()` | í•œê¸€ í¬í•¨ ì—¬ë¶€ í™•ì¸ | `execute_dual_query_search()` |
| `translate_to_english()` | í•œê¸€ â†’ ì˜ì–´ í‚¤ì›Œë“œ ë³€í™˜ | `execute_dual_query_search()` (í•œê¸€ ì§ˆë¬¸ì¼ ë•Œ) |
| `search_by_source()` | íŠ¹ì • ì†ŒìŠ¤ì—ì„œ ê²€ìƒ‰ | `execute_dual_query_search()` |
| `execute_dual_query_search()` | ë©”ì¸ ê²€ìƒ‰ ë¡œì§ | `run_test()` (í…ŒìŠ¤íŠ¸) |

### ì£¼ìš” ìƒìˆ˜

```python
PYDOC_FALLBACK_SCORE_THRESHOLD = 0.45
```

**ì˜ë¯¸**: python_doc_rst ë²ˆì—­ ê²€ìƒ‰ ê²°ê³¼ì˜ ìµœê³  ì ìˆ˜ê°€ ì´ ê°’ë³´ë‹¤ ë‚®ìœ¼ë©´, í•œê¸€ ì›ë¬¸ìœ¼ë¡œ fallback ê²€ìƒ‰ì„ ìˆ˜í–‰

---

## ì‹¤í–‰ ë°©ë²•

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
python src/agent/nodes/search_agent.py
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
======================================================================
ğŸ” ë“€ì–¼ ì¿¼ë¦¬ ê²€ìƒ‰ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
   í•œê¸€ ì§ˆë¬¸ â†’ í•œê¸€ + ì˜ì–´ ë™ì‹œ ê²€ìƒ‰
   ì˜ì–´ ì§ˆë¬¸ â†’ ì˜ì–´ë§Œ ê²€ìƒ‰
======================================================================

======================================================================
ğŸ“Œ [1/8] ì§ˆë¬¸: ë¨¸ì‹ ëŸ¬ë‹ì´ ë­ì•¼?
----------------------------------------------------------------------
â±ï¸  ê²€ìƒ‰ ì‹œê°„: 3.61ì´ˆ
ğŸ”¤ ì›ë³¸ ì¿¼ë¦¬: ë¨¸ì‹ ëŸ¬ë‹ì´ ë­ì•¼?
ğŸ”„ ë²ˆì—­ ì¿¼ë¦¬: machine learning concept definition supervised unsupervised

ğŸ“Š ê²€ìƒ‰ ê²°ê³¼: 3ê°œ
--------------------------------------------------
[1] ğŸ‡°ğŸ‡· ìœ ì‚¬ë„: 0.6910 | ì†ŒìŠ¤: lecture
    [ê°•ì˜ ìë£Œ ë‚´ìš©...]
[2] ğŸ‡°ğŸ‡· ìœ ì‚¬ë„: 0.6712 | ì†ŒìŠ¤: lecture
    [ê°•ì˜ ìë£Œ ë‚´ìš©...]
[3] ğŸ‡ºğŸ‡¸ ìœ ì‚¬ë„: 0.6581 | ì†ŒìŠ¤: python_doc_rst
    [Python ë¬¸ì„œ ë‚´ìš©...]
```

---

## ì£¼ìš” ì •ì±…

### 1. lecture ê²€ìƒ‰ ì •ì±…

- **ì–¸ì–´**: ì§ˆë¬¸ ì›ë¬¸ ê·¸ëŒ€ë¡œ (í•œê¸€ì´ë©´ í•œê¸€, ì˜ì–´ë©´ ì˜ì–´)
- **ì´ìœ **: lecture ë°ì´í„°ê°€ ëŒ€ë¶€ë¶„ í•œêµ­ì–´ í…ìŠ¤íŠ¸ë¼ì„œ

### 2. python_doc_rst ê²€ìƒ‰ ì •ì±…

- **í•œê¸€ ì§ˆë¬¸**:
  - ê¸°ë³¸: ì˜ì–´ ë²ˆì—­ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰
  - Fallback: ë²ˆì—­ ê²°ê³¼ê°€ ì•½í•˜ë©´(top1 score < 0.45) í•œê¸€ ì›ë¬¸ìœ¼ë¡œë„ 1ë²ˆ ë” ê²€ìƒ‰
- **ì˜ì–´ ì§ˆë¬¸**: ì›ë¬¸(ì˜ì–´) ê·¸ëŒ€ë¡œ ê²€ìƒ‰

### 3. ê²°ê³¼ í•©ì¹˜ê¸° ì •ì±…

- **ì¤‘ë³µ ì œê±°**: ì•ë¶€ë¶„ 100ì ê¸°ì¤€ìœ¼ë¡œ ë™ì¼í•œ ë‚´ìš©ì€ í•˜ë‚˜ë§Œ ìœ ì§€
- **ì •ë ¬**: ì ìˆ˜(score) ë‚´ë¦¼ì°¨ìˆœ
- **ìµœì¢… ë°˜í™˜**: top_kê°œë§Œ ë°˜í™˜

---

## ì˜ì¡´ì„±

### ì™¸ë¶€ ëª¨ë“ˆ

- `src.agent.nodes.search_router`: Router (sources, top_k ê²°ì •)
- `src.agent.nodes.search_executor`: SearchExecutor (Qdrant ê²€ìƒ‰ ì‹¤í–‰)
- `src.agent.prompts`: PROMPTS ë”•ì…”ë„ˆë¦¬ (TRANSLATE_PROMPT)

### í™˜ê²½ ìš”êµ¬ì‚¬í•­

- Qdrant ì‹¤í–‰ ì¤‘ (ê¸°ë³¸: localhost:6333)
- `.env`ì— `OPENAI_API_KEY` ì„¤ì • (ë²ˆì—­ + ì„ë² ë”©)

---

## ìˆ˜ì • ì‹œ ì£¼ì˜ì‚¬í•­

### 1. fallback ì„ê³„ê°’ ë³€ê²½

```python
PYDOC_FALLBACK_SCORE_THRESHOLD = 0.45  # ì´ ê°’ì„ ë³€ê²½í•˜ë©´
```

- **ë‚®ì¶”ë©´** (ì˜ˆ: 0.40): fallbackì´ ë” ìì£¼ ë°œìƒ â†’ ê²€ìƒ‰ íšŸìˆ˜ ì¦ê°€, ì•ˆì •ì„± í–¥ìƒ
- **ë†’ì´ë©´** (ì˜ˆ: 0.50): fallbackì´ ëœ ë°œìƒ â†’ ê²€ìƒ‰ íšŸìˆ˜ ê°ì†Œ, ë¹„ìš© ì ˆê°

### 2. ì¤‘ë³µ ì œê±° ê¸°ì¤€ ë³€ê²½

```python
content_key = r['content'].strip()[:100]  # ì´ ê¸¸ì´ë¥¼ ë³€ê²½í•˜ë©´
```

- **ê¸¸ì´ ì¦ê°€** (ì˜ˆ: `[:150]`): ë” ì—„ê²©í•œ ì¤‘ë³µ ì œê±°
- **ê¸¸ì´ ê°ì†Œ** (ì˜ˆ: `[:50]`): ë” ê´€ëŒ€í•œ ì¤‘ë³µ ì œê±°

### 3. ê²€ìƒ‰ ë¡œì§ ì¶”ê°€

ìƒˆë¡œìš´ ì†ŒìŠ¤ë‚˜ ê²€ìƒ‰ ì „ëµì„ ì¶”ê°€í•˜ë ¤ë©´ `execute_dual_query_search()` í•¨ìˆ˜ ë‚´ë¶€ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.

---

## ë¬¸ì œ í•´ê²°

### Q: "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”"

**í™•ì¸ ì‚¬í•­**:
1. Qdrantê°€ ì‹¤í–‰ ì¤‘ì¸ì§€
2. ì»¬ë ‰ì…˜ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€
3. Routerê°€ ì˜¬ë°”ë¥¸ sourcesë¥¼ ì„ íƒí–ˆëŠ”ì§€

### Q: "ë²ˆì—­ ê²°ê³¼ê°€ ì´ìƒí•´ìš”"

**í™•ì¸ ì‚¬í•­**:
1. `src/agent/prompts/translate_prompt.py`ì˜ í”„ë¡¬í”„íŠ¸ í™•ì¸
2. ë²ˆì—­ ê²°ê³¼ë¥¼ ë¡œê·¸ë¡œ ì¶œë ¥í•´ì„œ í™•ì¸

### Q: "ê²€ìƒ‰ ì ìˆ˜ê°€ ë„ˆë¬´ ë‚®ì•„ìš”"

**í™•ì¸ ì‚¬í•­**:
1. ì§ˆë¬¸ì´ í•œê¸€ì¸ë° ë²ˆì—­ì´ ì œëŒ€ë¡œ ë˜ì—ˆëŠ”ì§€
2. fallbackì´ ì‘ë™í–ˆëŠ”ì§€ (score < 0.45)
3. ë°ì´í„° ì¸ì œìŠ¤íŠ¸ í’ˆì§ˆ (RST ì •ì œ, ì²­í‚¹ ë“±)

---

## ìš”ì•½

- **ì—­í• **: ì‚¬ìš©ì ì§ˆë¬¸ì„ Qdrantì—ì„œ ê²€ìƒ‰í•´ì„œ top_kê°œ ê²°ê³¼ ë°˜í™˜
- **ì „ëµ**: ë“€ì–¼ ì¿¼ë¦¬(ì›ë¬¸+ë²ˆì—­), ì†ŒìŠ¤ë³„ ê²€ìƒ‰, ì–¸ì–´ ìµœì í™”
- **í•µì‹¬ í•¨ìˆ˜**: `execute_dual_query_search()` - ì „ì²´ ê²€ìƒ‰ ë¡œì§ ì‹¤í–‰
- **ì‹¤í–‰**: `python src/agent/nodes/search_agent.py`

