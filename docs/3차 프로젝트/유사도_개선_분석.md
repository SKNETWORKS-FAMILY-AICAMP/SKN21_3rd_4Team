# 유사도 개선 분석 및 개선 방안

## 현재 유사도 점수 분석 (터미널 출력 기준)

### 높은 점수 (0.55+)
- ✅ "리스트에 요소 추가하는 방법" → 0.6337
- ✅ "try except 예외 처리" → 0.5919
- ✅ "원시 문자열 리터럴" → 0.5822
- ✅ "for문에서 range 함수" → 0.5727
- ✅ "모듈 임포트" → 0.5704

### 중간 점수 (0.50-0.55)
- ⚠️ 대부분의 질문들 (정상 범위)

### 낮은 점수 (0.45-0.50)
- ❌ "딕셔너리 리터럴 사용법" → 0.4597
- ❌ "with문으로 파일 열기" → 0.4641
- ❌ "파일 객체 메서드" → 0.4873

---

## 개선 방안

### 1. 번역 프롬프트 개선 (우선순위: 높음)

#### 문제점
- "딕셔너리 리터럴" → "dictionary literal usage dict syntax {}" (0.4597)
- Python 문서에서는 "dictionary display"가 더 정확한 용어

#### 개선 방안
```python
# translate_prompt.py 개선
- "dictionary display" 용어 추가
- 더 구체적인 예시 추가:
  예) dictionary display, dict literal, dict comprehension, dict methods
  예) with statement, context manager, file object methods
```

**예상 효과**: +0.05~0.10 유사도 향상

---

### 2. RST 전처리 개선 (우선순위: 중간)

#### 현재 상태
- ✅ API 시그니처 보존 (class, function, method)
- ✅ 코드 블록 보존
- ✅ 섹션 제목 프리픽스 추가 ([TITLE], [H1], [H2])

#### 개선 방안

##### 2-1. 더 많은 컨텍스트 정보 추가
```python
# ingestion_rst.py 개선
prefix_lines = [
    f"[TITLE] {d.metadata.get('title', '')}",
    f"[H1] {d.metadata.get('section', '')}",
    f"[H2] {d.metadata.get('subsection', '')}",
    # 추가: API 시그니처가 있으면 포함
    f"[API] {api_signature}" if api_signature else "",
]
```

##### 2-2. 코드 예제 키워드 추출
```python
# 코드 블록에서 중요한 키워드 추출
# 예: "list.append(x)" → "append method list"
code_keywords = extract_keywords_from_code(code_block)
if code_keywords:
    prefix += f"\n[KEYWORDS] {code_keywords}"
```

##### 2-3. 청킹 전략 개선
```python
# 현재: chunk_size=900, chunk_overlap=200
# 개선: 의미 단위로 더 나누기
separators = [
    "\n\n",           # 단락 구분
    "\n::",           # 코드 블록
    "\n.. ",          # directive
    "\nmethod ",      # 메서드 정의 (추가)
    "\nclass ",       # 클래스 정의 (추가)
    "\ndef ",         # 함수 정의 (추가)
    "\n",
]
```

**예상 효과**: +0.03~0.08 유사도 향상

---

### 3. 검색 쿼리 최적화 (우선순위: 중간)

#### 문제점
- 일부 번역이 너무 일반적: "usage", "syntax" 같은 단어
- Python 문서의 정확한 용어와 불일치

#### 개선 방안

##### 3-1. 번역 프롬프트에 용어 사전 추가
```python
# translate_prompt.py
용어 매핑:
- "리터럴" → "literal" 또는 "display" (컨텍스트에 따라)
- "사용법" → 구체적인 메서드/함수명 포함
- "차이점" → "difference" + 구체적 타입명
```

##### 3-2. 쿼리 확장 (Query Expansion)
```python
# 검색 전 쿼리 확장
original_query = "dictionary literal"
expanded_query = "dictionary display dict literal dict comprehension"
# 동의어/관련어 추가
```

**예상 효과**: +0.02~0.05 유사도 향상

---

### 4. 청킹 크기 조정 (우선순위: 낮음)

#### 현재 설정
- chunk_size: 900
- chunk_overlap: 200

#### 개선 방안
```python
# 더 작은 청크로 나누기 (의미 단위)
chunk_size: 600-700  # 더 집중된 컨텍스트
chunk_overlap: 150   # 적절한 중복
```

**예상 효과**: +0.01~0.03 유사도 향상 (하지만 청크 수 증가)

---

### 5. 메타데이터 활용 (우선순위: 낮음)

#### 현재 상태
- metadata에 section, subsection, has_code 저장
- 검색 시 필터링만 사용

#### 개선 방안
```python
# 검색 시 메타데이터 가중치 추가
# 예: section이 일치하면 가중치 증가
if query_section in hit.metadata.get('section', ''):
    score *= 1.1  # 10% 가중치
```

**예상 효과**: +0.01~0.02 유사도 향상

---

## 우선순위별 실행 계획

### Phase 1: 즉시 개선 (높은 효과)
1. ✅ 번역 프롬프트 개선 - Python 문서 용어 정확히 매핑
2. ✅ 번역 예시 추가 - "dictionary display", "with statement" 등

### Phase 2: 중기 개선 (중간 효과)
3. ✅ RST 전처리 - API 시그니처 더 잘 보존
4. ✅ 청킹 전략 - 의미 단위로 개선

### Phase 3: 장기 개선 (낮은 효과)
5. ⚠️ 쿼리 확장 - 동의어 추가
6. ⚠️ 메타데이터 가중치 - 검색 점수 조정

---

## 예상 최종 효과

- **현재 평균 유사도**: ~0.52
- **개선 후 예상 평균**: ~0.58-0.62
- **낮은 점수 질문 개선**: 0.45 → 0.55+ (목표)

---

## 참고사항

1. **유사도 0.45-0.50도 정상**: 코사인 유사도에서 0.4 이상이면 관련 문서로 간주
2. **번역 품질이 가장 중요**: 한글 → 영어 키워드 변환이 핵심
3. **RST 문서 용어 정확성**: Python 공식 문서의 정확한 용어 사용이 중요

