# 2026-01-07 하이브리드 검색 작업 정리

## 📋 작업 개요

오늘은 벡터 검색 성능 향상을 위해 전처리 및 프롬프트 수정을 반복하며 실험을 진행했습니다. 특히 **하이브리드 검색**이 성능 향상에 효과적이라는 것을 확인했습니다.

---

## ✅ 주요 성과

### 1. 하이브리드 검색 성능 확인
- **벡터 검색 + 키워드 매칭** 조합이 성능 향상에 효과적임을 확인
- 특히 **RST 기반 문서(python_doc)**에서 더욱 효과적
- 벡터 검색의 의미적 유사도 + 키워드 매칭의 정확한 용어 보장으로 검색 품질 개선

### 2. 구현 상태

#### `src/vector_search.py` (테스트용)
- ✅ **벡터 검색 + 키워드 매칭 + BM25(Sparse 검색)** 모두 구현됨
- 하이브리드 검색 함수: `hybrid_search()`
  - 벡터 점수 가중치: 0.6
  - 키워드 점수 가중치: 0.2
  - BM25 점수 가중치: 0.2
- BM25 점수 계산 함수: `calculate_bm25_score()`
- 키워드 매칭 점수 계산 함수: `calculate_keyword_score()`

#### `src/agent/nodes/search_agent.py` (메인 기능)
- ✅ **벡터 검색 + 키워드 매칭**만 구현됨
- 하이브리드 검색 함수: `search_by_source()` 내부
  - 벡터 점수 가중치: 0.7
  - 키워드 점수 가중치: 0.3
- BM25는 아직 미적용

---

## 🤔 현재 고민 사항

### 하이브리드 검색 전략 선택

#### 옵션 1: 키워드 매칭만 사용
- **장점**: 구현이 간단하고 빠름
- **단점**: 성능 향상이 제한적일 수 있음

#### 옵션 2: 키워드 매칭 + BM25(Sparse 검색) 추가
- **장점**: 성능 향상이 더 크게 기대됨 (특히 RST 기반 문서)
- **단점**: 
  - 구현 난이도가 높음
  - BM25는 전체 문서 집합에서 IDF를 계산해야 정확함
  - 현재는 간단한 근사 방식 사용 중

### 현재 상태
- `vector_search.py`: 둘 다 적용된 상태 (테스트용)
- `search_agent.py`: 키워드만 적용된 상태 (메인 기능)

---

## 📁 파일별 역할

### `src/vector_search.py` (테스트 전용)
- **목적**: 벡터 검색 품질 테스트 및 실험
- **기능**:
  - 다양한 임베딩 모델 테스트
  - 하이브리드 검색 실험 (벡터 + 키워드 + BM25)
  - 결과 저장 (JSON, CSV, 요약 리포트)
- **상태**: 테스트용으로 완전한 하이브리드 검색 구현 완료

### `src/agent/nodes/search_agent.py` (메인 기능)
- **목적**: 실제 검색 에이전트의 메인 기능
- **기능**:
  - 듀얼 쿼리 검색 (lecture + python_doc)
  - 한글 질문 → 영어 번역 검색
  - 하이브리드 검색 (벡터 + 키워드)
- **상태**: 
  - 키워드 매칭만 적용됨
  - 테스트 코드 포함 (삭제 예정)

---

## 🔄 향후 계획

### 1. 테스트 전략
- **테스트는 `src/vector_search.py`에서만 수행**
- 다양한 하이브리드 검색 조합 실험
- BM25 추가 시 성능 비교

### 2. 메인 기능 정리
- `src/agent/nodes/search_agent.py`의 테스트 코드 삭제 예정
- 메인 기능만 남기고 깔끔하게 정리

### 3. 하이브리드 검색 전략 결정
- 테스트 결과를 바탕으로 최종 전략 결정
- 키워드만 사용할지, BM25도 추가할지 결정

---

## 🚀 하이브리드 검색 실행 방법

### `src/vector_search.py` (테스트용)

#### 기본 실행 (벡터 검색만)
```bash
python src/vector_search.py
```

#### 하이브리드 검색 실행 (벡터 + 키워드 + BM25)
```bash
python src/vector_search.py --hybrid
```

#### 추가 옵션
```bash
# 특정 임베딩 모델 사용
python src/vector_search.py --hybrid --embedding-model text-embedding-3-large

# 특정 컬렉션 사용
python src/vector_search.py --hybrid --collection learning_ai_rst_v2

# 번역 기능 비활성화
python src/vector_search.py --hybrid --no-translation

# 결과 저장 비활성화
python src/vector_search.py --hybrid --no-save
```

### `src/agent/nodes/search_agent.py` (메인 기능)

#### 기본 실행 (벡터 검색만)
```bash
python src/agent/nodes/search_agent.py
```

#### 하이브리드 검색 실행 (벡터 + 키워드)
```bash
python src/agent/nodes/search_agent.py --hybrid
```

#### 코드에서 사용
```python
from src.agent.nodes.search_agent import execute_dual_query_search

# 벡터 검색만
results, query_info = execute_dual_query_search(query, use_hybrid=False)

# 하이브리드 검색 (벡터 + 키워드)
results, query_info = execute_dual_query_search(query, use_hybrid=True)
```

---

## 📊 하이브리드 검색 구현 상세

### 벡터 검색 + 키워드 매칭 (현재 search_agent.py)
```python
hybrid_score = vector_score * 0.7 + keyword_score * 0.3
```

### 벡터 검색 + 키워드 매칭 + BM25 (현재 vector_search.py)
```python
hybrid_score = (
    vector_score * 0.6 +
    keyword_score * 0.2 +
    bm25_score * 0.2
)
```

### BM25 점수 계산
- TF (Term Frequency): 키워드가 문서에 나타나는 빈도
- IDF (Inverse Document Frequency): 간단한 근사 방식 사용
- 문서 길이 정규화 포함
- 파라미터: k1=1.5, b=0.75

---

## 🔄 Search Agent 흐름도

### `execute_dual_query_search()` 함수 흐름

```
사용자 질문 입력
    ↓
[1] 질문 언어 판별
    ├─ is_korean(query) → 한글/영어 판별
    ↓
[2] LLM 검색 설정 결정
    ├─ build_search_config(query)
    ├─ top_k 결정 (basic=3, intermediate=5, advanced=7)
    └─ sources 결정 (["lecture", "python_doc"])
    ↓
[3] 소스별 검색 시작
    │
    ├─ [3-1] lecture 검색
    │   ├─ query 원문으로 검색
    │   ├─ search_by_source(query, "lecture", top_k, use_hybrid)
    │   └─ 결과 수집
    │
    └─ [3-2] python_doc 검색
        │
        ├─ 한글 질문인가?
        │   ├─ YES
        │   │   ├─ [3-2-1] 번역 검색 (기본)
        │   │   │   ├─ translate_to_english(query)
        │   │   │   ├─ search_by_source(english_query, "python_doc", top_k, use_hybrid)
        │   │   │   └─ query_type = "translated"
        │   │   │
        │   │   └─ [3-2-2] Fallback 검색 (조건부)
        │   │       ├─ 번역 결과 점수 < 0.45?
        │   │       ├─ YES → search_by_source(query, "python_doc", top_k, use_hybrid)
        │   │       └─ query_type = "original"
        │   │
        │   └─ NO (영어 질문)
        │       ├─ search_by_source(query, "python_doc", top_k, use_hybrid)
        │       └─ query_type = "original"
        │
        └─ 결과 수집
    ↓
[4] 결과 합치기
    ├─ lecture_results + python_results
    └─ all_results에 추가
    ↓
[5] 중복 제거
    ├─ content[:100] 기준으로 중복 체크
    └─ unique_results 생성
    ↓
[6] 점수순 정렬
    ├─ score 기준 내림차순 정렬
    └─ top_k만 선택
    ↓
최종 결과 반환 (results, query_info)
```

### 하이브리드 검색 상세 흐름 (`search_by_source()` 내부)

```
search_by_source(query, source, top_k, use_hybrid)
    ↓
use_hybrid == True?
    │
    ├─ YES (하이브리드 검색)
    │   ├─ [1] 벡터 검색으로 후보 가져오기
    │   │   ├─ candidate_k = min(top_k * 4, 20)
    │   │   ├─ query_vector = embedding.embed_query(query)
    │   │   └─ Qdrant 벡터 검색 (limit=candidate_k)
    │   │
    │   ├─ [2] 키워드 추출
    │   │   ├─ query_cleaned = query.replace(',', ' ').replace(';', ' ').replace(':', ' ')
    │   │   └─ query_keywords = [kw for kw in query_cleaned.split() if len(kw) > 2]
    │   │
    │   ├─ [3] 각 후보에 대해 점수 계산
    │   │   ├─ vector_score = hit.score
    │   │   ├─ keyword_score = calculate_keyword_score(query_keywords, content)
    │   │   └─ hybrid_score = vector_score * 0.7 + keyword_score * 0.3
    │   │
    │   └─ [4] 하이브리드 점수로 정렬 → top_k 반환
    │
    └─ NO (일반 벡터 검색)
        ├─ query_vector = embedding.embed_query(query)
        ├─ Qdrant 벡터 검색 (limit=top_k)
        └─ 결과 반환
```

### 주요 함수 역할

| 함수 | 역할 |
|------|------|
| `is_korean(query)` | 질문에 한글이 포함되어 있는지 확인 |
| `build_search_config(query)` | LLM으로 top_k, sources 결정 |
| `translate_to_english(query)` | 한글 질문을 영어 검색 키워드로 번역 |
| `search_by_source(query, source, top_k, use_hybrid)` | 특정 소스에서 검색 (하이브리드 옵션) |
| `calculate_keyword_score(keywords, content)` | 키워드 매칭 점수 계산 (0.0~1.0) |
| `execute_dual_query_search(query, use_hybrid)` | 전체 듀얼 쿼리 검색 실행 |

---

## 📝 참고 사항

### 하이브리드 검색의 효과
- RST 기반 문서(python_doc)에서 특히 효과적
- 정확한 용어가 포함된 문서를 상위로 올림
- 벡터 검색의 의미적 유사도는 유지하면서 정확도 향상

### 테스트 결과 저장 위치
- `results/vector_search/` 폴더에 저장
- JSON, CSV, 요약 리포트 형식으로 저장
- 메타데이터 포함 (임베딩 모델, 프롬프트 버전, 전처리 설정 등)

### Fallback 전략
- python_doc에서 한글 질문 시:
  1. 먼저 영어 번역 쿼리로 검색 (기본)
  2. 번역 결과의 최고 점수가 0.45 미만이면 한글 원문으로도 추가 검색
- 이렇게 하면 번역이 부정확해도 원문으로 보완 가능

---

## 🎯 다음 단계

1. **테스트 진행**: `vector_search.py`에서 다양한 하이브리드 검색 조합 실험
2. **성능 비교**: 키워드만 vs 키워드+BM25 성능 비교
3. **최종 결정**: 테스트 결과를 바탕으로 메인 기능에 적용할 전략 결정
4. **코드 정리**: `search_agent.py`의 테스트 코드 삭제 및 메인 기능만 유지

---

## 📌 메모

- 하이브리드 검색이 성능 향상에 효과적이라는 것을 확인했지만, 최적의 조합은 아직 실험 중
- BM25는 구현 난이도가 높지만 성능 향상이 기대됨
- RST 기반 문서에서 하이브리드 검색의 효과가 더 크게 나타남
